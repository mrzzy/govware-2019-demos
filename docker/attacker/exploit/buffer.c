/*
 * buffer.h
 * Buffer Support 
*/


#include <fcntl.h>
#include <unistd.h>
#include <errno.h>

#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <stdbool.h>

#include "buffer.h"

// reads the contents of the file at filepath entirely into the buffer
// returns the buffer with the contests of the file or NULL if failed to read
Buffer read_path(const char *filepath)
{  
    Buffer buffer = { NULL, 0 };

    // open the file for reading 
    FILE *target_file = fopen(filepath, "r");
    if(target_file == NULL)
    {
        printf("[ERR] Failed to open file %s\n", filepath);
        return buffer; // blank buffer 
    }
    
    // determine the size of the file so that we can later allocate sufficent
    // menory to read the entire file. 
    fseek(target_file, 0L, SEEK_END); // 1. go to the end of file
    size_t file_len = ftell(target_file); // 2. get position at end aka size
    rewind(target_file); // 3. return back to the start of file.

    // read the file in a contents buffer
    void *contents = malloc(file_len);
    size_t read_len = fread(contents, file_len, 1, target_file);
    if(read_len != file_len)
    {
        printf("[ERR] Failed to read file %s\n", filepath);
        free(contents);
        return buffer; // blank buffer 
    }
    
    // construct buffer
    buffer.contents = contents;
    buffer.size = file_len;

    return buffer;
}
